# Руководство по настройке асинхронного парсинга

## Обзор параметров

В системе асинхронного парсинга используются два ключевых параметра:

- **WORKER_COUNT** - количество параллельных worker'ов (горутин)
- **BATCH_SIZE** - размер батча ключевых слов для обработки одним worker'ом

## Как это работает

### Архитектура обработки

```
1000 ключевых слов
├── Батч 1: ключевые слова 1-50   (Worker 1)
├── Батч 2: ключевые слова 51-100 (Worker 2)
├── Батч 3: ключевые слова 101-150 (Worker 3)
├── ...
└── Батч 20: ключевые слова 951-1000 (Worker 10)
```

### Worker Pool

- Максимум одновременно работающих worker'ов = `WORKER_COUNT`
- Каждый worker обрабатывает один батч последовательно
- После завершения батча worker освобождается для следующего

## Рекомендуемые значения

### Для небольших проектов (до 500 ключевых слов)

```env
WORKER_COUNT=5
BATCH_SIZE=25
```

**Обоснование:**
- Низкая нагрузка на внешние API
- Быстрая обработка небольших объемов
- Минимальное потребление ресурсов

### Для средних проектов (500-2000 ключевых слов)

```env
WORKER_COUNT=10
BATCH_SIZE=50
```

**Обоснование:**
- Сбалансированная производительность
- Разумная нагрузка на внешние сервисы
- Хорошая пропускная способность

### Для крупных проектов (2000+ ключевых слов)

```env
WORKER_COUNT=20
BATCH_SIZE=100
```

**Обоснование:**
- Высокая производительность
- Эффективное использование ресурсов
- Быстрая обработка больших объемов

## Ограничения и предупреждения

### WORKER_COUNT

**Минимальное значение:** 1
**Максимальное значение:** 50

**⚠️ Предупреждения:**
- Слишком много worker'ов (>30) могут перегрузить внешние API
- Может привести к блокировке IP-адреса
- Увеличивает потребление памяти

**Рекомендации:**
- Начните с 10 worker'ов
- Увеличивайте постепенно, мониторя ошибки API
- Учитывайте лимиты внешних сервисов

### BATCH_SIZE

**Минимальное значение:** 1
**Максимальное значение:** 200

**⚠️ Предупреждения:**
- Слишком большие батчи (>150) увеличивают время обработки одного батча
- При ошибке в батче теряется больше работы
- Может привести к таймаутам

**Рекомендации:**
- Оптимальный размер: 25-100 ключевых слов
- Учитывайте время ответа внешних API
- Балансируйте между скоростью и надежностью

## Мониторинг и оптимизация

### Ключевые метрики

1. **Время обработки батча**
   - Норма: 30-120 секунд на батч
   - Тревога: >300 секунд

2. **Количество ошибок API**
   - Норма: <5% от общего количества запросов
   - Тревога: >10%

3. **Использование памяти**
   - Норма: <1GB на 1000 ключевых слов
   - Тревога: >2GB

### Настройка под ваши нужды

#### Если много ошибок API:
```env
WORKER_COUNT=5    # Уменьшить количество worker'ов
BATCH_SIZE=25     # Уменьшить размер батча
```

#### Если медленная обработка:
```env
WORKER_COUNT=20   # Увеличить количество worker'ов
BATCH_SIZE=100    # Увеличить размер батча
```

#### Если проблемы с памятью:
```env
WORKER_COUNT=10   # Уменьшить количество worker'ов
BATCH_SIZE=50     # Уменьшить размер батча
```

## Примеры конфигураций

### Конфигурация для разработки
```env
WORKER_COUNT=3
BATCH_SIZE=10
```

### Конфигурация для продакшена (малый трафик)
```env
WORKER_COUNT=8
BATCH_SIZE=40
```

### Конфигурация для продакшена (высокий трафик)
```env
WORKER_COUNT=15
BATCH_SIZE=75
```

### Конфигурация для максимальной производительности
```env
WORKER_COUNT=25
BATCH_SIZE=100
```

## Лимиты внешних сервисов

### XMLRiver/XMLStock
- **Рекомендуемый лимит:** 10-15 запросов в секунду
- **Максимальный лимит:** 20 запросов в секунду
- **При превышении:** Блокировка IP на 1 час

### Wordstat
- **Рекомендуемый лимит:** 5-10 запросов в секунду
- **Максимальный лимит:** 15 запросов в секунду
- **При превышении:** Временная блокировка

## Формула расчета нагрузки

```
Запросов в секунду = (WORKER_COUNT * BATCH_SIZE) / среднее_время_обработки_батча
```

**Пример:**
- WORKER_COUNT = 10
- BATCH_SIZE = 50
- Среднее время обработки батча = 60 секунд
- Запросов в секунду = (10 * 50) / 60 = 8.3

## Заключение

Настройка асинхронного парсинга требует баланса между:
- Скоростью обработки
- Нагрузкой на внешние API
- Потреблением ресурсов
- Надежностью системы

Начните с рекомендуемых значений и корректируйте их на основе мониторинга производительности и ошибок.
